---
name: "Setup Rust nightly"
description: "Sets up our Rust nightly toolchains"
outputs:
  nightly_version:
    description: The nightly version of Rust
    value: ${{ steps.nightly.outputs.nightly }}

runs:
  using: "composite"
  steps:
    - name: Install nightly Rust to use for certain tools (fuzzing, cargo-udeps)
      id: nightly
      run: |
        NIGHTLY="nightly-2025-09-30"
        # Check if nightly toolchain is already installed
        if ! rustup toolchain list | grep -q "$NIGHTLY"; then
          rustup toolchain install $NIGHTLY
          rustup component add rust-src --toolchain $NIGHTLY
        fi
        echo "nightly=$NIGHTLY" >> $GITHUB_OUTPUT
      shell: bash

      # Fix-up mtime of toolchain files
      # Inspired by https://github.com/est31/cargo-udeps/issues/149.
    - name: Modify mtime of toolchain files
      if: ${{ runner.os == 'Linux' }}
      run: find ~/.rustup/toolchains/nightly-2025-09-30-x86_64-unknown-linux-gnu -print0 | xargs -0 touch -d '2025-09-30'
      shell: bash
    - name: Modify mtime of toolchain files
      if: ${{ runner.os == 'macOS' }}
      run: find ~/.rustup/toolchains/nightly-2025-09-30-aarch64-apple-darwin -print0 | xargs -0 touch -t 202509300000
      shell: bash
    - name: Modify mtime of toolchain files
      if: ${{ runner.os == 'Windows' }}
      shell: powershell
      run: Get-ChildItem -Path "$env:USERPROFILE\.rustup\toolchains\nightly-2025-09-30-x86_64-pc-windows-msvc" -Recurse | ForEach-Object { $_.LastWriteTime = '2025-09-30' }

    - name: Install nightly Rust for compiling eBPF code
      run: |
        NIGHTLY="nightly-2025-05-30"
        # Check if nightly toolchain is already installed
        if ! rustup toolchain list | grep -q "$NIGHTLY"; then
          rustup toolchain install $NIGHTLY
          rustup component add rust-src --toolchain $NIGHTLY
        fi
      shell: bash
