defmodule PortalWeb.BannerTest do
  use PortalWeb.ConnCase, async: true

  setup do
    account = Fixtures.Accounts.create_account()
    actor = Fixtures.Actors.create_actor(type: :account_admin_user, account: account)
    identity = Fixtures.Auth.create_identity(account: account, actor: actor)

    %{
      account: account,
      actor: actor,
      identity: identity
    }
  end

  test "shows banner when one exists", %{
    conn: conn,
    account: account,
    identity: identity
  } do
    banner = Fixtures.Banners.create_banner(message: "Test Banner Message")

    {:ok, _lv, html} = conn |> authorize_conn(identity) |> live(~p"/#{account}/sites")

    assert html
           |> Floki.parse_fragment!()
           |> Floki.find("div#banner")
           |> Floki.text()
           |> String.contains?(banner.message)
  end

  test "does not show banner when none exists", %{
    conn: conn,
    account: account,
    identity: identity
  } do
    {:ok, _lv, html} = conn |> authorize_conn(identity) |> live(~p"/#{account}/sites")

    assert Enum.empty?(
             html
             |> Floki.parse_fragment!()
             |> Floki.find("div#banner")
           )
  end
end
